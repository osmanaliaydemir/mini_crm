@page
@model CRM.Web.Pages.Finance.Cashbox.IndexModel
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Finance_Cashbox_Page_Title"];
}

@section Styles {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@@tarekraafat/autocomplete.js@10.2.7/dist/css/autoComplete.min.css" integrity="sha384-H7Uyx3SOzxHnF/YBCfS7qiL1FyB1Hp5zXwGrgFw1xI1BEgYHEi5lqgd9j5u6fEji" crossorigin="anonymous">
    <link rel="stylesheet" href="~/css/finance/cashbox/list.css" asp-append-version="true" />
}

<section class="page-header cashbox-header">
    <div>
        <h1>@Localizer["Finance_Cashbox_Page_Title"]</h1>
        <p class="subtitle">@Localizer["Finance_Cashbox_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-primary" asp-page="Create">@Localizer["Finance_Cashbox_Action_Create"]</a>
    </div>
</section>

<section class="filter-bar cashbox-filter">
    <form method="get" class="filter-form">
        <div class="filter-field">
            <label for="cashbox-from">@Localizer["Finance_Cashbox_Filter_From"]</label>
            <input id="cashbox-from"
                   type="date"
                   name="from"
                   value="@Model.Filter.From?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-field">
            <label for="cashbox-to">@Localizer["Finance_Cashbox_Filter_To"]</label>
            <input id="cashbox-to"
                   type="date"
                   name="to"
                   value="@Model.Filter.To?.ToString("yyyy-MM-dd")" />
        </div>
        <div class="filter-field">
            <label for="cashbox-type">@Localizer["Finance_Cashbox_Filter_Type"]</label>
            <select id="cashbox-type" name="type">
                <option value="">@Localizer["Finance_Cashbox_Filter_Type_All"]</option>
                @foreach (var option in Model.TransactionTypeOptions)
                {
                    <option value="@option.Value" selected="@(Model.Filter.Type == option.Value)">
                        @option.Text
                    </option>
                }
            </select>
        </div>
        <div class="filter-actions">
            <button type="submit" class="btn btn-primary">@Localizer["Finance_Cashbox_Filter_Search"]</button>
            <a class="btn btn-ghost" asp-page="Index">@Localizer["Finance_Cashbox_Filter_Clear"]</a>
        </div>
    </form>
</section>

<section class="kpi-grid cashbox-kpis">
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Finance_Cashbox_Header_TotalIncome"]</span>
        <div class="kpi-value">@Model.Summary.TotalIncome.ToString("C2")</div>
        <span class="kpi-meta">@Localizer["Finance_Cashbox_Header_TotalIncome_Subtitle"]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Finance_Cashbox_Header_TotalExpense"]</span>
        <div class="kpi-value negative">@Model.Summary.TotalExpense.ToString("C2")</div>
        <span class="kpi-meta">@Localizer["Finance_Cashbox_Header_TotalExpense_Subtitle"]</span>
    </article>
    <article class="kpi-card accent">
        <span class="kpi-label">@Localizer["Finance_Cashbox_Header_NetBalance"]</span>
        <div class="kpi-value">@Model.Summary.NetBalance.ToString("C2")</div>
        <span class="kpi-meta">@Localizer["Finance_Cashbox_Header_NetBalance_Subtitle"]</span>
    </article>
</section>

<section class="cashbox-insights">
    <article class="card analytics-card">
        <header class="card-header">
            <div>
                <h2>@Localizer["Finance_Cashbox_Chart_Monthly_Title"]</h2>
                <p>@Localizer["Finance_Cashbox_Chart_Monthly_Description"]</p>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="cashboxMonthlyChart" data-cashbox-chart></canvas>
        </div>
    </article>
    <article class="card category-card">
        <header class="card-header">
            <h2>@Localizer["Finance_Cashbox_Category_Title"]</h2>
        </header>
        <ul class="category-list">
            @if (Model.RecentTransactions.Any())
            {
                foreach (var tx in Model.RecentTransactions)
                {
                    <li>
                        <div class="category-meta">
                            <div class="category-info">
                                <span class="name">@tx.Description</span>
                                <span class="balance @(tx.TransactionType == CRM.Domain.Finance.CashTransactionType.Income ? "positive" : "negative")">
                                    @(tx.TransactionType == CRM.Domain.Finance.CashTransactionType.Income ? "+" : "-")@tx.Amount.ToString("C2")
                                </span>
                            </div>
                        </div>
                        <div class="category-stats">
                            <span class="date">
                                @tx.TransactionDate.ToString("g")
                            </span>
                            <span class="category">
                                @(string.IsNullOrWhiteSpace(tx.Category) ? Localizer["Finance_Cashbox_Category_Unspecified"].Value : tx.Category)
                            </span>
                        </div>
                    </li>
                }
            }
            else
            {
                <li class="empty">@Localizer["Finance_Cashbox_Category_NoData"]</li>
            }
        </ul>
    </article>
</section>

<section class="cashbox-table-section">
    <article class="card table-card wide">
        <header class="card-header">
            <div>
                <h2>@Localizer["Finance_Cashbox_Table_Title"]</h2>
                <p>@Localizer["Finance_Cashbox_Table_Subtitle"]</p>
            </div>
            <div class="table-actions">
                <label class="search-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <circle cx="11" cy="11" r="7" />
                        <path d="m20 20-3.5-3.5" />
                    </svg>
                    <input type="search" data-cashbox-search placeholder="@Localizer["Finance_Cashbox_Search_Placeholder"].Value" />
                </label>
                <button type="button" class="btn btn-ghost" data-cashbox-search-clear>@Localizer["Finance_Cashbox_Filter_Clear"]</button>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="cashboxTable" class="data-table" data-order-column="0">
                <thead>
                    <tr>
                        <th>@Localizer["Finance_Cashbox_Table_Date"]</th>
                        <th>@Localizer["Finance_Cashbox_Table_Type"]</th>
                        <th>@Localizer["Finance_Cashbox_Table_Category"]</th>
                        <th>@Localizer["Finance_Cashbox_Table_Description"]</th>
                        <th class="text-end">@Localizer["Finance_Cashbox_Table_Amount"]</th>
                        <th>@Localizer["Finance_Cashbox_Table_Customer"]</th>
                        <th>@Localizer["Finance_Cashbox_Table_Shipment"]</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Transactions.Any())
                {
                    @foreach (var tx in Model.Transactions)
                {
                    <tr>
                        <td>@tx.TransactionDate.ToString("g")</td>
                        <td>
                            <span class="status-chip @(tx.TransactionType == CRM.Domain.Finance.CashTransactionType.Income ? "status-chip--positive" : "status-chip--negative")">
                                @(tx.TransactionType == CRM.Domain.Finance.CashTransactionType.Income
                                    ? Localizer["Finance_Cashbox_Type_Income"]
                                    : Localizer["Finance_Cashbox_Type_Expense"])
                            </span>
                        </td>
                        <td>@(string.IsNullOrWhiteSpace(tx.Category) ? Localizer["Finance_Cashbox_Category_Unspecified"] : tx.Category)</td>
                        <td>@tx.Description</td>
                        <td class="text-end">
                            <div class="cell-strong">@tx.Amount.ToString("C2")</div>
                            <div class="cell-subtext">@tx.Currency</div>
                        </td>
                        <td>@(tx.RelatedCustomerName ?? Localizer["Finance_Cashbox_Value_None"].Value)</td>
                        <td>@(tx.RelatedShipmentReference ?? Localizer["Finance_Cashbox_Value_None"].Value)</td>
                    </tr>
                    }
                }
                </tbody>
            </table>
            @if (!Model.Transactions.Any())
            {
                <div class="table-empty-message" style="display: none; padding: 2rem; text-align: center; color: #64748b;">
                    @Localizer["Finance_Cashbox_Table_NoRecords"]
                </div>
            }
        </div>
    </article>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js" integrity="sha384-XwU4NLexM4ZRMeNZFmVDk4LvyTgT4X8JNRlmVzDeQu5C65Qxe5neg+KMRJ0Pfi3b" crossorigin="anonymous"></script>
    <script>
        window.cashboxDashboard = {
            chart: {
                labels: @Html.Raw(Model.MonthlyLabelsJson ?? "[]"),
                income: @Html.Raw(Model.MonthlyIncomeDataJson ?? "[]"),
                expense: @Html.Raw(Model.MonthlyExpenseDataJson ?? "[]"),
                net: @Html.Raw(Model.MonthlyNetDataJson ?? "[]"),
                noDataMessage: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Finance_Cashbox_Chart_NoData"].Value))
            }
        };
    </script>
    <script src="~/js/finance/cashbox/list.js" asp-append-version="true"></script>
}

