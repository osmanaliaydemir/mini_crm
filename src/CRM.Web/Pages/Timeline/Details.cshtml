@page "{entityType:int}/{entityId:guid}"
@model CRM.Web.Pages.Timeline.DetailsModel
@using CRM.Application.Timeline
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Timeline_Details_Title"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/timeline/index.css" asp-append-version="true" />
}

<section class="page-header timeline-header">
    <div>
        <h1>@Localizer["Timeline_Details_Title"]</h1>
        <p class="subtitle">
            @if (!string.IsNullOrWhiteSpace(Model.EntityName))
            {
                <text>@Model.EntityName</text>
            }
            else
            {
                <text>@Localizer["Timeline_Details_Subtitle"]</text>
            }
        </p>
    </div>
    <div class="header-actions">
        <a class="btn btn-ghost" asp-page="Index">@Localizer["Timeline_Back"]</a>
    </div>
</section>

@if (Model.Timeline != null)
{
    <section class="timeline-content">
        @if (Model.Timeline.Items.Count == 0)
        {
            <article class="card">
                <div class="card-body">
                    <p class="empty-message">@Localizer["Timeline_Empty"]</p>
                </div>
            </article>
        }
        else
        {
            <article class="card">
                <div class="card-body">
                    <ul class="timeline-list">
                        @foreach (var item in Model.Timeline.Items)
                        {
                            <li class="timeline-item">
                                <div class="timeline-marker @GetActivityTypeClass(item.Type)"></div>
                                <div class="timeline-content">
                                    <div class="timeline-header">
                                        <span class="timeline-time">@item.OccurredAt.ToLocalTime().ToString("dd.MM.yyyy HH:mm")</span>
                                        <span class="timeline-type-badge @GetActivityTypeClass(item.Type)">@GetActivityTypeLabel(item.Type)</span>
                                    </div>
                                    <div class="timeline-title">@GetActivityTitle(item)</div>
                                    <div class="timeline-description">@item.Description</div>
                                    @if (!string.IsNullOrWhiteSpace(item.UserName))
                                    {
                                        <div class="timeline-user">@Localizer["Timeline_By"] @item.UserName</div>
                                    }
                                </div>
                            </li>
                        }
                    </ul>

                    @if (Model.Timeline.TotalPages > 1)
                    {
                        <div class="pagination">
                            @if (Model.Timeline.PageNumber > 1)
                            {
                                <a asp-page="Details" asp-route-entityType="@((int)Model.ActivityType)" asp-route-entityId="@Model.EntityId" 
                                   asp-route-PageNumber="@(Model.Timeline.PageNumber - 1)" 
                                   class="btn btn-ghost">@Localizer["Common_Previous"]</a>
                            }

                            <span class="pagination-info">
                                @Localizer["Common_Page_Info", Model.Timeline.PageNumber, Model.Timeline.TotalPages, Model.Timeline.TotalCount]
                            </span>

                            @if (Model.Timeline.PageNumber < Model.Timeline.TotalPages)
                            {
                                <a asp-page="Details" asp-route-entityType="@((int)Model.ActivityType)" asp-route-entityId="@Model.EntityId" 
                                   asp-route-PageNumber="@(Model.Timeline.PageNumber + 1)" 
                                   class="btn btn-ghost">@Localizer["Common_Next"]</a>
                            }
                        </div>
                    }
                </div>
            </article>
        }
    </section>
}

@functions {
    string GetActivityTypeClass(ActivityType type) => type switch
    {
        ActivityType.Shipment => "type-shipment",
        ActivityType.Customer => "type-customer",
        ActivityType.Task => "type-task",
        ActivityType.Finance => "type-finance",
        ActivityType.Warehouse => "type-warehouse",
        ActivityType.Supplier => "type-supplier",
        ActivityType.CustomerInteraction => "type-interaction",
        ActivityType.EmailAutomation => "type-automation",
        _ => "type-other"
    };

    string GetActivityTypeLabel(ActivityType type) => Localizer[$"Timeline_ActivityType_{type}"].Value;

    string GetActivityTitle(ActivityTimelineItem item)
    {
        var actionLabel = Localizer[$"Timeline_ActivityAction_{item.Action}"].Value;
        var typeLabel = GetActivityTypeLabel(item.Type);

        return $"{actionLabel} {typeLabel}";
    }
}

