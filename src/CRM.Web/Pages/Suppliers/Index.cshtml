@page
@model CRM.Web.Pages.Suppliers.IndexModel
@using System.Text.Json
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Suppliers_Page_Title"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/suppliers/list.css" asp-append-version="true" />
}

<section class="page-header suppliers-header">
    <div>
        <h1>@Localizer["Suppliers_Page_Title"]</h1>
        <p class="subtitle">@Localizer["Suppliers_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-primary" asp-page="Create">
            @Localizer["Suppliers_Action_Create"]
        </a>
    </div>
</section>

<section class="kpi-grid suppliers-kpis">
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Suppliers_Header_TotalSuppliers"]</span>
        <div class="kpi-value">@Model.TotalSuppliers</div>
        <span class="kpi-meta">@Localizer["Suppliers_Header_Last30Days_Value", Model.RecentSuppliersCount]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Suppliers_Header_Countries"]</span>
        <div class="kpi-value">@Model.DistinctCountryCount</div>
        <span class="kpi-meta">@Localizer["Suppliers_Header_Countries_Subtitle"]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Suppliers_Header_TopCountry"]</span>
        <div class="kpi-value">@Model.TopCountryName</div>
        <span class="kpi-meta">@Localizer["Suppliers_Header_TopCountry_Value", Model.TopCountrySupplierCount]</span>
    </article>
</section>

<section class="suppliers-insights">
    <article class="card analytics-card">
        <header class="card-header">
            <div>
                <h2>@Localizer["Suppliers_Chart_ByCountry_Title"]</h2>
                <p>@Localizer["Suppliers_Chart_ByCountry_Description"]</p>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="suppliersByCountryChart" data-suppliers-chart></canvas>
        </div>
    </article>
    <article class="card top-countries-card">
        <header class="card-header">
            <h2>@Localizer["Suppliers_TopCountries_Title"]</h2>
        </header>
        <ul class="top-country-list">
            @if (Model.SupplierCountryStats.Any())
            {
                var rank = 1;
                foreach (var stat in Model.SupplierCountryStats.Take(5))
                {
                    <li>
                        <span class="rank">@rank</span>
                        <span class="country">@stat.Country</span>
                        <span class="count">@Localizer["Suppliers_TopCountries_Count", stat.SupplierCount]</span>
                    </li>
                    rank++;
                }
            }
            else
            {
                <li class="empty">@Localizer["Suppliers_Chart_NoData"]</li>
            }
        </ul>
    </article>
</section>

<section class="suppliers-table-section">
    <article class="card table-card wide" data-suppliers-table>
        <header class="card-header">
            <div>
                <h2>@Localizer["Suppliers_Table_Title"]</h2>
                <p>@Localizer["Suppliers_Table_Subtitle"]</p>
            </div>
            <div class="table-actions">
                <label class="search-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <circle cx="11" cy="11" r="7" />
                        <path d="m20 20-3.5-3.5" />
                    </svg>
                    <input type="search" data-suppliers-search placeholder="@Localizer["Suppliers_Search_Placeholder"].Value" />
                </label>
                <button type="button" class="btn btn-ghost" data-suppliers-search-clear>@Localizer["Customers_Clear_Button"]</button>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="suppliersTable" class="data-table" data-order-column="0">
                <thead>
                    <tr>
                        <th>@Localizer["Suppliers_Table_Name"]</th>
                        <th>@Localizer["Suppliers_Table_Country"]</th>
                        <th>@Localizer["Suppliers_Table_Tax"]</th>
                        <th>@Localizer["Suppliers_Table_Contact"]</th>
                        <th class="text-end">@Localizer["Suppliers_Table_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Suppliers.Any())
                {
                    @foreach (var supplier in Model.Suppliers)
                    {
                        <tr>
                            <td>
                                <div class="cell-strong">@supplier.Name</div>
                                @if (!string.IsNullOrWhiteSpace(supplier.AddressLine))
                                {
                                    <div class="cell-subtext">@supplier.AddressLine</div>
                                }
                            </td>
                            <td>@supplier.Country</td>
                            <td>@supplier.TaxNumber</td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(supplier.ContactEmail) || !string.IsNullOrWhiteSpace(supplier.ContactPhone))
                                {
                                    @if (!string.IsNullOrWhiteSpace(supplier.ContactEmail))
                                    {
                                        <div class="cell-strong">@supplier.ContactEmail</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(supplier.ContactPhone))
                                    {
                                        <div class="cell-subtext">@supplier.ContactPhone</div>
                                    }
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td class="text-end">
                                <a class="btn btn-icon" asp-page="Details" asp-route-id="@supplier.Id" title="@Localizer["Suppliers_Action_Details"]">
                                    <img src="~/images/detail.png" alt="@Localizer["Suppliers_Action_Details"]" width="18" height="18" loading="lazy" />
                                </a>
                                <a class="btn btn-icon" asp-page="Edit" asp-route-id="@supplier.Id" title="@Localizer["Suppliers_Action_Edit"]">
                                    <img src="~/images/edit.png" alt="@Localizer["Suppliers_Action_Edit"]" width="18" height="18" loading="lazy" />
                                </a>
                                <a class="btn btn-icon" asp-page="Delete" asp-route-id="@supplier.Id" title="@Localizer["Suppliers_Action_Delete"]">
                                    <img src="~/images/delete.png" alt="@Localizer["Suppliers_Action_Delete"]" width="18" height="18" loading="lazy" />
                                </a>
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
            @if (!Model.Suppliers.Any())
            {
                <div class="table-empty-message" style="display: none; padding: 2rem; text-align: center; color: #64748b;">
                    @Localizer["Suppliers_Table_Empty"]
                </div>
            }
        </div>
    </article>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        window.suppliersDashboard = {
            chart: {
                labels: @Html.Raw(Model.SupplierCountryChartLabelsJson ?? "[]"),
                data: @Html.Raw(Model.SupplierCountryChartDataJson ?? "[]"),
                noDataMessage: @Html.Raw(JsonSerializer.Serialize(Localizer["Suppliers_Chart_NoData"].Value)),
                datasetLabel: @Html.Raw(JsonSerializer.Serialize(Localizer["Suppliers_Header_TotalSuppliers"].Value))
            }
        };
    </script>
    <script src="~/js/suppliers/list.js" asp-append-version="true"></script>
}
