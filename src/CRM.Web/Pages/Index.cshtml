@page
@model IndexModel
@using System.Globalization
@using System.Text.Json
@using CRM.Web
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    ViewData["Title"] = Localizer["Dashboard_Title"];
    var currencyCulture = CultureInfo.CurrentCulture;
    var numberCulture = CultureInfo.CurrentCulture;
    string FormatCurrency(decimal value) => value.ToString("C0", currencyCulture);
}

<section class="row g-4 mb-1">
    <div class="col-12">
        <div class="dashboard-section">
            <div class="d-flex flex-column flex-lg-row justify-content-between align-items-lg-center gap-3">
                <div>
                    <h1 class="h3 mb-1">@Localizer["Dashboard_Title"]</h1>
                    <p class="text-secondary mb-0">@Localizer["Dashboard_Intro"]</p>
                </div>
               @*  <div class="d-flex flex-wrap gap-2">
                    <a asp-page="/Shipments/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewShipments"]</a>
                    <a asp-page="/Suppliers/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewSuppliers"]</a>
                    <a asp-page="/Warehouses/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewWarehouses"]</a>
                    <a asp-page="/Customers/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewCustomers"]</a>
                    <a asp-page="/Finance/PaymentPlans/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewPayments"]</a>
                    <a asp-page="/Finance/Cashbox/Index" class="btn btn-outline-primary">@Localizer["Dashboard_Link_ViewCashbox"]</a>
                </div> *@
            </div>
        </div>
    </div>
</section>

<section class="row g-3 mb-4">
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_ActiveShipments"]</span>
            <div class="display-6 fw-semibold mt-2">@Model.Summary.ActiveShipments</div>
            <small class="text-secondary">@Localizer["Shipments_Status_Departed"]</small>
            <a asp-page="/Shipments/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewShipments"]"></a>
        </div>
    </div>
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_CustomsShipments"]</span>
            <div class="display-6 fw-semibold mt-2">@Model.Summary.ShipmentsInCustoms</div>
            <small class="text-secondary">@Localizer["Shipments_Status_InCustoms"]</small>
            <a asp-page="/Shipments/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewShipments"]"></a>
        </div>
    </div>
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_Delivered30"]</span>
            <div class="display-6 fw-semibold mt-2">@Model.Summary.DeliveredLast30Days</div>
            <small class="text-secondary">@Localizer["Shipments_Status_DeliveredToDealer"]</small>
            <a asp-page="/Shipments/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewShipments"]"></a>
        </div>
    </div>
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_TotalSuppliers"]</span>
            <div class="display-6 fw-semibold mt-2">@Model.Summary.TotalSuppliers</div>
            <small class="text-secondary">@Localizer["Dashboard_Chart_SupplierCountries"]</small>
            <a asp-page="/Suppliers/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewSuppliers"]"></a>
        </div>
    </div>
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_TotalCustomers"]</span>
            <div class="display-6 fw-semibold mt-2">@Model.Summary.TotalCustomers</div>
            <small class="text-secondary">@Localizer["Dashboard_Section_CRM"]</small>
            <a asp-page="/Customers/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewCustomers"]"></a>
        </div>
    </div>
    <div class="col-xxl-2 col-md-4 col-sm-6">
        <div class="dashboard-section h-100 position-relative">
            <span class="text-uppercase text-secondary small">@Localizer["Dashboard_Summary_CashNet30"]</span>
            <div class="display-6 fw-semibold mt-2">@FormatCurrency(Model.Summary.CashNetLast30)</div>
            <small class="text-secondary">@Localizer["Dashboard_Section_Finance"]</small>
            <a asp-page="/Finance/Cashbox/Index" class="stretched-link" aria-label="@Localizer["Dashboard_Link_ViewCashbox"]"></a>
        </div>
    </div>
</section>

<section class="row g-4 mb-4">
    <div class="col-xl-5">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_Shipments"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_ShipmentStatus"]</p>
                    </div>
                    <a asp-page="/Shipments/Index" class="btn btn-sm btn-outline-primary">@Localizer["Dashboard_Link_ViewShipments"]</a>
                </div>
                <div class="chart-wrapper" id="shipmentStatusChartContainer">
                    <canvas id="shipmentStatusChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_Shipments"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_ShipmentTrend"]</p>
                    </div>
                </div>
                <div class="chart-wrapper" id="shipmentTrendChartContainer">
                    <canvas id="shipmentTrendChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="row g-4 mb-4">
    <div class="col-xl-5">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_Operations"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_SupplierCountries"]</p>
                    </div>
                    <a asp-page="/Suppliers/Index" class="btn btn-sm btn-outline-primary">@Localizer["Dashboard_Link_ViewSuppliers"]</a>
                </div>
                <div class="chart-wrapper" id="supplierCountryChartContainer">
                    <canvas id="supplierCountryChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-7">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_Operations"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_WarehouseVolume"]</p>
                    </div>
                    <a asp-page="/Warehouses/Index" class="btn btn-sm btn-outline-primary">@Localizer["Dashboard_Link_ViewWarehouses"]</a>
                </div>
                <div class="chart-wrapper" id="warehouseVolumeChartContainer">
                    <canvas id="warehouseVolumeChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

<section class="row g-4">
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_Finance"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_CashFlow"]</p>
                    </div>
                    <a asp-page="/Finance/Cashbox/Index" class="btn btn-sm btn-outline-primary">@Localizer["Dashboard_Link_ViewCashbox"]</a>
                </div>
                <div class="chart-wrapper" id="cashFlowChartContainer">
                    <canvas id="cashFlowChart"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div class="col-xl-6">
        <div class="card shadow-sm border-0 h-100">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-start mb-3">
                    <div>
                        <h5 class="card-title mb-1">@Localizer["Dashboard_Section_CRM"]</h5>
                        <p class="card-subtitle small mb-0">@Localizer["Dashboard_Chart_CustomerInteractions"]</p>
                    </div>
                    <a asp-page="/Customers/Index" class="btn btn-sm btn-outline-primary">@Localizer["Dashboard_Link_ViewCustomers"]</a>
                </div>
                <div class="chart-wrapper" id="customerInteractionChartContainer">
                    <canvas id="customerInteractionChart"></canvas>
                </div>
            </div>
        </div>
    </div>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            const locale = document.documentElement.lang || 'en';
            const emptyStateHtml = '<div class="text-muted small">@Localizer["Dashboard_NoData"]</div>';
            const unspecifiedToken = "@IndexModel.SupplierUnspecifiedToken";
            const unspecifiedLabelLocalized = @Html.Raw(JsonSerializer.Serialize(Localizer["Dashboard_Unspecified"].Value));

            const shipmentStatusLabels = @Html.Raw(JsonSerializer.Serialize(Model.ShipmentStatusSummaries.Select(s => Localizer[$"Shipments_Status_{s.Status}"].Value)));
            const shipmentStatusData = @Html.Raw(JsonSerializer.Serialize(Model.ShipmentStatusSummaries.Select(s => s.Count)));

            if (shipmentStatusData.length > 0 && typeof Chart !== 'undefined') {
                const statusCtx = document.getElementById('shipmentStatusChart');
                new Chart(statusCtx, {
                    type: 'doughnut',
                    data: {
                        labels: shipmentStatusLabels,
                        datasets: [{
                            data: shipmentStatusData,
                            backgroundColor: ['#2563eb', '#10b981', '#f59e0b', '#ef4444', '#64748b', '#0ea5e9'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        plugins: {
                            legend: {
                                position: 'bottom'
                            }
                        }
                    }
                });
            } else {
                document.getElementById('shipmentStatusChartContainer').innerHTML = emptyStateHtml;
            }

            const shipmentTrendLabelsRaw = @Html.Raw(JsonSerializer.Serialize(Model.ShipmentMonthlyTrend.Select(p => p.PeriodStart.ToString("yyyy-MM-01"))));
            const shipmentTrendData = @Html.Raw(JsonSerializer.Serialize(Model.ShipmentMonthlyTrend.Select(p => Math.Round((double)p.Value, 2))));

            if (shipmentTrendData.length > 0 && typeof Chart !== 'undefined') {
                const formattedLabels = shipmentTrendLabelsRaw.map(x => new Date(x + 'T00:00:00Z').toLocaleDateString(locale, { month: 'short', year: 'numeric' }));
                const trendCtx = document.getElementById('shipmentTrendChart');
                new Chart(trendCtx, {
                    type: 'line',
                    data: {
                        labels: formattedLabels,
                        datasets: [{
                            label: '@Localizer["Dashboard_Chart_ShipmentTrend"]',
                            data: shipmentTrendData,
                            borderColor: '#2563eb',
                            backgroundColor: 'rgba(37, 99, 235, 0.15)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#2563eb'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('shipmentTrendChartContainer').innerHTML = emptyStateHtml;
            }

            const supplierCountryLabelsRaw = @Html.Raw(JsonSerializer.Serialize(Model.SupplierCountryBreakdown.Select(p => p.Label)));
            const supplierCountryData = @Html.Raw(JsonSerializer.Serialize(Model.SupplierCountryBreakdown.Select(p => p.Value)));

            if (supplierCountryData.length > 0 && typeof Chart !== 'undefined') {
                const supplierCountryLabels = supplierCountryLabelsRaw.map(label => label === unspecifiedToken ? unspecifiedLabelLocalized : label);
                const supplierCtx = document.getElementById('supplierCountryChart');
                new Chart(supplierCtx, {
                    type: 'bar',
                    data: {
                        labels: supplierCountryLabels,
                        datasets: [{
                            label: '@Localizer["Dashboard_Chart_SupplierCountries"]',
                            data: supplierCountryData,
                            backgroundColor: '#10b981'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('supplierCountryChartContainer').innerHTML = emptyStateHtml;
            }

            const warehouseVolumeLabelsRaw = @Html.Raw(JsonSerializer.Serialize(Model.WarehouseVolumeTrend.Select(p => p.PeriodStart.ToString("yyyy-MM-01"))));
            const warehouseVolumeData = @Html.Raw(JsonSerializer.Serialize(Model.WarehouseVolumeTrend.Select(p => Math.Round((double)p.Value, 2))));

            if (warehouseVolumeData.length > 0 && typeof Chart !== 'undefined') {
                const warehouseLabels = warehouseVolumeLabelsRaw.map(x => new Date(x + 'T00:00:00Z').toLocaleDateString(locale, { month: 'short', year: 'numeric' }));
                const warehouseCtx = document.getElementById('warehouseVolumeChart');
                new Chart(warehouseCtx, {
                    type: 'line',
                    data: {
                        labels: warehouseLabels,
                        datasets: [{
                            label: '@Localizer["Dashboard_Chart_WarehouseVolume"]',
                            data: warehouseVolumeData,
                            borderColor: '#0ea5e9',
                            backgroundColor: 'rgba(14, 165, 233, 0.18)',
                            fill: true,
                            tension: 0.35,
                            pointRadius: 4,
                            pointBackgroundColor: '#0ea5e9'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                document.getElementById('warehouseVolumeChartContainer').innerHTML = emptyStateHtml;
            }

            const cashFlowLabelsRaw = @Html.Raw(JsonSerializer.Serialize(Model.CashFlowTrend.Select(p => p.PeriodStart.ToString("yyyy-MM-01"))));
            const cashFlowData = @Html.Raw(JsonSerializer.Serialize(Model.CashFlowTrend.Select(p => Math.Round((double)p.Value, 2))));

            if (cashFlowData.length > 0 && typeof Chart !== 'undefined') {
                const cashLabels = cashFlowLabelsRaw.map(x => new Date(x + 'T00:00:00Z').toLocaleDateString(locale, { month: 'short', year: 'numeric' }));
                const cashCtx = document.getElementById('cashFlowChart');
                new Chart(cashCtx, {
                    type: 'bar',
                    data: {
                        labels: cashLabels,
                        datasets: [{
                            label: '@Localizer["Dashboard_Chart_CashFlow"]',
                            data: cashFlowData,
                            backgroundColor: cashFlowData.map(value => value >= 0 ? 'rgba(16, 185, 129, 0.75)' : 'rgba(239, 68, 68, 0.75)')
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true
                            }
                        }
                    }
                });
            } else {
                document.getElementById('cashFlowChartContainer').innerHTML = emptyStateHtml;
            }

            const interactionLabelsRaw = @Html.Raw(JsonSerializer.Serialize(Model.CustomerInteractionTrend.Select(p => p.PeriodStart.ToString("yyyy-MM-01"))));
            const interactionData = @Html.Raw(JsonSerializer.Serialize(Model.CustomerInteractionTrend.Select(p => Math.Round((double)p.Value, 2))));

            if (interactionData.length > 0 && typeof Chart !== 'undefined') {
                const interactionLabels = interactionLabelsRaw.map(x => new Date(x + 'T00:00:00Z').toLocaleDateString(locale, { month: 'short', year: 'numeric' }));
                const interactionCtx = document.getElementById('customerInteractionChart');
                new Chart(interactionCtx, {
                    type: 'line',
                    data: {
                        labels: interactionLabels,
                        datasets: [{
                            label: '@Localizer["Dashboard_Chart_CustomerInteractions"]',
                            data: interactionData,
                            borderColor: '#f97316',
                            backgroundColor: 'rgba(249, 115, 22, 0.18)',
                            fill: true,
                            tension: 0.4,
                            pointRadius: 4,
                            pointBackgroundColor: '#f97316'
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    precision: 0
                                }
                            }
                        }
                    }
                });
            } else {
                document.getElementById('customerInteractionChartContainer').innerHTML = emptyStateHtml;
            }
        });
    </script>
}
