@page
@model CRM.Web.Pages.Notifications.Automation.IndexModel
@using CRM.Domain.Notifications
@using System.Text.Json
@inject Microsoft.Extensions.Localization.IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["EmailAutomation_Page_Title"];
}

@section Styles {
    <link rel="stylesheet" href="~/css/common/datatable.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/notifications/automation.css" asp-append-version="true" />
}

@if (TempData["StatusMessage"] != null)
{
    <div class="flash-message @(TempData["StatusMessageType"]?.ToString() ?? "success")">
        <span class="flash-message__text">@TempData["StatusMessage"]</span>
    </div>
}

<section class="page-header">
    <div>
        <h1>@Localizer["EmailAutomation_Page_Title"]</h1>
        <p class="subtitle">@Localizer["EmailAutomation_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-primary" asp-page="Create">@Localizer["EmailAutomation_Action_Create"]</a>
    </div>
</section>

<article class="card table-card">
    <header class="card-header">
        <div>
            <h2>@Localizer["EmailAutomation_Table_Title"]</h2>
            <p>@Localizer["EmailAutomation_Table_Description"]</p>
        </div>
        <div class="table-actions">
            <label class="search-control">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                    <circle cx="11" cy="11" r="7" />
                    <path d="m20 20-3.5-3.5" />
                </svg>
                <input type="search" data-automation-search placeholder="@Localizer["Common_Search"].Value" />
            </label>
            <button type="button" class="btn btn-ghost" data-automation-search-clear>@Localizer["Common_Clear"]</button>
        </div>
    </header>
    <div class="table-wrapper">
        <table id="automationRulesTable" class="data-table" data-order-column="0" data-order-direction="asc">
            <thead>
                <tr>
                    <th>@Localizer["EmailAutomation_Table_Name"]</th>
                    <th>@Localizer["EmailAutomation_Table_Resource"]</th>
                    <th>@Localizer["EmailAutomation_Table_Trigger"]</th>
                    <th>@Localizer["EmailAutomation_Table_Execution"]</th>
                    <th>@Localizer["EmailAutomation_Table_Recipients"]</th>
                    <th>@Localizer["EmailAutomation_Table_Status"]</th>
                    <th class="text-end">@Localizer["EmailAutomation_Table_Actions"]</th>
                </tr>
            </thead>
            <tbody></tbody>
        </table>
       @*  <div class="table-empty-message" style="display: none; padding: 2rem; text-align: center; color: #64748b;">
            @Localizer["EmailAutomation_Table_Empty"]
        </div> *@

    </div>
</article>

@if (Model.Rules.Count > 0)
{
    <div class="automation-hidden-forms" style="display:none;" aria-hidden="true">
        @foreach (var rule in Model.Rules)
        {
            <form method="post"
                  asp-page-handler="ToggleStatus"
                  asp-route-id="@rule.Id"
                  data-no-loader="true"
                  id="toggle-form-@rule.Id">
                @Html.AntiForgeryToken()
            </form>
        }
    </div>
}

@section Scripts {
    <script>
        window.emailAutomationTableData = @Html.Raw(Model.AutomationTableJson ?? "[]");
        window.emailAutomationTableConfig = {
            viewLabel: @Html.Raw(JsonSerializer.Serialize(Localizer["EmailAutomation_Action_View"].Value)),
            editLabel: @Html.Raw(JsonSerializer.Serialize(Localizer["EmailAutomation_Action_Edit"].Value)),
            deleteLabel: @Html.Raw(JsonSerializer.Serialize(Localizer["EmailAutomation_Action_Delete"].Value)),
            toggleLabelActive: @Html.Raw(JsonSerializer.Serialize(Localizer["EmailAutomation_Action_Activate"].Value)),
            toggleLabelInactive: @Html.Raw(JsonSerializer.Serialize(Localizer["EmailAutomation_Action_Deactivate"].Value)),
            deleteClass: "text-danger"
        };
    </script>
    <script src="~/js/notifications/automation-list.js" asp-append-version="true"></script>
}

