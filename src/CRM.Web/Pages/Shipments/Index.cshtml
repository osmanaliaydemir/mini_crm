@page
@model CRM.Web.Pages.Shipments.IndexModel
@using CRM.Domain.Enums
@using CRM.Web
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@section Styles {
    <link rel="stylesheet" href="~/css/common/datatable.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/shipments/list.css" asp-append-version="true" />
}

@section Scripts {
    <script src="~/js/shipments/list.js" asp-append-version="true"></script>
}

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Shipments_Title"];
}

<section class="page-header">
    <div>
        <h1>@Localizer["Shipments_Title"]</h1>
        <p class="subtitle">@Localizer["Shipments_Header_Total_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <div class="btn-group">
            <a class="btn btn-ghost" asp-page-handler="Export" asp-route-format="excel">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                @Localizer["Common_Export_Excel"]
            </a>
            <a class="btn btn-ghost" asp-page-handler="Export" asp-route-format="csv">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                @Localizer["Common_Export_CSV"]
            </a>
        </div>
        <a class="btn btn-primary" asp-page="Create">
            @Localizer["Shipments_Add_Button"]
        </a>
    </div>
</section>

<section class="kpi-grid shipments-kpis" data-shipments-kpis>
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Shipments_Header_Total"].Value, 
        value = Model.TotalShipments, 
        meta = Localizer["Shipments_Header_Total_Subtitle"].Value,
        dataKpi = "total"
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Shipments_Header_Active"].Value, 
        value = Model.ActiveShipments, 
        meta = Localizer["Shipments_Header_Active_Subtitle"].Value,
        dataKpi = "active"
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Shipments_Header_Delivered"].Value, 
        value = Model.DeliveredShipments, 
        meta = Localizer["Shipments_Header_Delivered_Subtitle"].Value,
        dataKpi = "delivered"
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Shipments_Header_Customs"].Value, 
        value = Model.CustomsShipments, 
        meta = Localizer["Shipments_Header_Customs_Subtitle"].Value,
        dataKpi = "customs"
    })
</section>

@if (Model.StatusSummaries?.Any() ?? false)
{
    <section class="filter-bar shipments-toolbar" data-shipments-toolbar>
        <div class="filter-group" data-filter-group="status" role="group" aria-label="@Localizer["Shipments_Status_Breakdown_Title"]">
            <button class="filter-chip active" data-status-filter="all" aria-pressed="true">
                <span class="chip-label">@Localizer["Finance_Cashbox_Filter_Type_All"]</span>
                <span class="chip-count" data-total-count>@Model.TotalShipments</span>
            </button>
            @foreach (var summary in Model.StatusSummaries)
            {
                var statusLabel = Localizer[$"Shipments_Status_{summary.Status}"].Value;
                <button class="filter-chip" data-status-filter="@summary.Status" data-status-label="@statusLabel" data-status-count="@summary.Count" aria-pressed="false">
                    <span class="chip-label">@statusLabel</span>
                    <span class="chip-count">@summary.Count</span>
                </button>
            }
        </div>
        <div class="filter-search">
            <label class="search-control">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                    <circle cx="11" cy="11" r="7" />
                    <path d="m20 20-3.5-3.5" />
                </svg>
                <input type="search" data-table-search placeholder="@Localizer["Shipments_Search_Placeholder"].Value" />
            </label>
            <button type="button" class="btn btn-ghost" data-clear-search>@Localizer["Customers_Clear_Button"]</button>
        </div>
    </section>
}

<section class="shipments-table-section" data-shipments-table>
    <article class="card table-card wide">
        <header class="card-header">
            <div>
                <h2>@Localizer["Shipments_Title"]</h2>
                <p>@Localizer["Shipments_Header_Total_Subtitle"]</p>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="shipmentsTable" class="data-table" data-crm-datatable="true" data-responsive="true" data-order-column="5" data-status-column="3">
                <thead>
                    <tr>
                        <th>@Localizer["Shipments_Table_Reference"]</th>
                        <th>@Localizer["Shipments_Table_Supplier"]</th>
                        <th>@Localizer["Shipments_Table_Customer"]</th>
                        <th>@Localizer["Shipments_Table_Status"]</th>
                        <th>@Localizer["Shipments_Table_LastUpdate"]</th>
                        <th>@Localizer["Shipments_Table_ShipmentDate"]</th>
                        <th>@Localizer["Shipments_Table_EstimatedArrival"]</th>
                        <th class="text-end">@Localizer["Shipments_Table_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var shipment in Model.Shipments)
                    {
                        var statusLabel = Localizer[$"Shipments_Status_{shipment.Status}"].Value;
                        var statusClass = Model.GetStatusBadgeClass(shipment.Status);
                        <tr data-status="@shipment.Status">
                            <td>
                                <div class="cell-strong">@shipment.ReferenceNumber</div>
                                @if (!string.IsNullOrWhiteSpace(shipment.LastStageNotes))
                                {
                                    <div class="cell-subtext">@shipment.LastStageNotes</div>
                                }
                            </td>
                            <td>@shipment.SupplierName</td>
                            <td>@shipment.CustomerName</td>
                            <td>
                                @await Component.InvokeAsync("StatusBadge", new { 
                                    label = statusLabel, 
                                    statusType = statusClass.Replace("status-chip--", ""),
                                    cssClass = "status-chip"
                                })
                            </td>
                            <td>
                                @(shipment.LastStageUpdate.HasValue
                                    ? shipment.LastStageUpdate.Value.ToLocalTime().ToString("g")
                                    : Localizer["Shipments_Table_NoUpdate"].Value)
                            </td>
                            <td>@shipment.ShipmentDate.ToLocalTime().ToString("d")</td>
                            <td>
                                @(shipment.EstimatedArrival.HasValue
                                    ? shipment.EstimatedArrival.Value.ToLocalTime().ToString("d")
                                    : "-")
                            </td>
                            <td class="text-end">
                                <a class="btn btn-icon" asp-page="Details" asp-route-id="@shipment.Id" title="@Localizer["Shipments_Action_Details"]">
                                    <img src="~/images/detail.png" alt="@Localizer["Shipments_Action_Details"]" width="18" height="18" loading="lazy" />
                                </a>
                                <a class="btn btn-icon" asp-page="Edit" asp-route-id="@shipment.Id" title="@Localizer["Shipments_Action_Edit"]">
                                    <img src="~/images/edit.png" alt="@Localizer["Shipments_Action_Edit"]" width="18" height="18" loading="lazy" />
                                </a>
                            </td>
                        </tr>
                    }
                    @if (!Model.Shipments.Any())
                    {
                        <tr>
                            <td colspan="8" class="empty-state">@Localizer["Shipments_Table_Empty"]</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </article>
</section>

