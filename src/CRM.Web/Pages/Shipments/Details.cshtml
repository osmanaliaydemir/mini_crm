@page "{id:guid}"
@model CRM.Web.Pages.Shipments.DetailsModel
@using CRM.Domain.Enums
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    if (Model.Shipment is null)
    {
        ViewData["Title"] = Localizer["Shipments_Details_NotFound_Title"];
    }
    else
    {
        ViewData["Title"] = $"{Localizer["Shipments_Details_Title"]} · {Model.Shipment.ReferenceNumber}";
    }
}

@section Styles {
    <link rel="stylesheet" href="~/css/shipments/details.css" asp-append-version="true" />
}

@if (Model.Shipment is null)
{
    <section class="details-empty">
        <article class="details-card">
            <h2>@Localizer["Shipments_Details_NotFound_Title"]</h2>
            <p>@Localizer["Shipments_Details_NotFound_Message"]</p>
            <div class="details-actions">
                <a class="btn btn-primary" asp-page="Index">@Localizer["Shipments_Action_Back"]</a>
            </div>
        </article>
    </section>
}
else
{
    var shipment = Model.Shipment;
    var firstStage = shipment.Stages.FirstOrDefault();
    var lastStage = shipment.Stages.LastOrDefault();
    string ResolveStageClass(ShipmentStatus status) => status switch
    {
        ShipmentStatus.DeliveredToDealer or ShipmentStatus.InWarehouse => "timeline-marker status-positive",
        ShipmentStatus.Cancelled => "timeline-marker status-warning",
        ShipmentStatus.InCustoms or ShipmentStatus.OnTruck or ShipmentStatus.AtPort => "timeline-marker status-warning",
        _ => "timeline-marker"
    };

    <section class="page-header details-header">
        <div>
            <h1>@Localizer["Shipments_Details_Title"]</h1>
            <p class="subtitle">@shipment.ReferenceNumber</p>
        </div>
        <div class="header-actions">
            <a class="btn btn-ghost" asp-page="Index">@Localizer["Shipments_Action_Back"]</a>
            <a class="btn btn-primary" asp-page="Edit" asp-route-id="@shipment.Id">@Localizer["Shipments_Action_Edit"]</a>
        </div>
    </section>

    <section class="details-summary">
        <article class="details-summary-card">
            <span class="summary-label">@Localizer["Shipments_Form_Status"]</span>
            <div class="summary-value">@Localizer[$"Shipments_Status_{shipment.Status}"]</div>
            <span class="summary-meta">@Localizer["Shipments_Form_Reference"] · @shipment.ReferenceNumber</span>
        </article>
        <article class="details-summary-card">
            <span class="summary-label">@Localizer["Shipments_Form_ShipmentDate"]</span>
            <div class="summary-value">@shipment.ShipmentDate.ToLocalTime().ToString("d")</div>
            <span class="summary-meta">@shipment.ShipmentDate.ToLocalTime().ToString("t")</span>
        </article>
        <article class="details-summary-card">
            <span class="summary-label">@Localizer["Shipments_Form_EstimatedArrival"]</span>
            <div class="summary-value">@(shipment.EstimatedArrival?.ToLocalTime().ToString("d") ?? "-")</div>
            <span class="summary-meta">@shipment.EstimatedArrival?.ToLocalTime().ToString("t")</span>
        </article>
        <article class="details-summary-card">
            <span class="summary-label">@Localizer["Shipments_Form_Supplier"]</span>
            <div class="summary-value">@(shipment.SupplierName ?? "-")</div>
            <span class="summary-meta">@Localizer["Shipments_Form_Customer"] · @(shipment.CustomerName ?? "-")</span>
        </article>
    </section>

    <section class="details-grid">
        <article class="details-card overview-card">
            <header>
                <h2>@Localizer["Shipments_Details_Overview_Title"]</h2>
            </header>
            <dl class="details-definition">
                <div>
                    <dt>@Localizer["Shipments_Form_LoadingPort"]</dt>
                    <dd>@(!string.IsNullOrWhiteSpace(shipment.LoadingPort) ? shipment.LoadingPort : "-")</dd>
                </div>
                <div>
                    <dt>@Localizer["Shipments_Form_DischargePort"]</dt>
                    <dd>@(!string.IsNullOrWhiteSpace(shipment.DischargePort) ? shipment.DischargePort : "-")</dd>
                </div>
                <div>
                    <dt>@Localizer["Shipments_Details_Stage_First"]</dt>
                    <dd>@(firstStage?.StartedAt.ToLocalTime().ToString("g") ?? "-")</dd>
                </div>
                <div>
                    <dt>@Localizer["Shipments_Details_Stage_Last"]</dt>
                    <dd>@(lastStage?.CompletedAt?.ToLocalTime().ToString("g") ?? "-")</dd>
                </div>
            </dl>
        </article>

        <article class="details-card notes-card">
            <header>
                <h2>@Localizer["Shipments_Details_Notes_Title"]</h2>
            </header>
            @if (!string.IsNullOrWhiteSpace(shipment.Notes))
            {
                <p>@shipment.Notes</p>
            }
            else
            {
                <p class="empty">@Localizer["Shipments_Details_Notes_Empty"]</p>
            }
        </article>

        <article class="details-card timeline-card">
            <header>
                <h2>@Localizer["Shipments_Details_Stages_Title"]</h2>
            </header>
            @if (shipment.Stages.Count == 0)
            {
                <p class="empty">@Localizer["Shipments_Timeline_NoStages"]</p>
            }
            else
            {
                <ul class="timeline">
                    @foreach (var stage in shipment.Stages)
                    {
                        <li class="timeline-entry">
                            <div class="@ResolveStageClass(stage.Status)"></div>
                            <div class="timeline-content">
                                <div class="timeline-title">@Localizer[$"Shipments_Status_{stage.Status}"]</div>
                                <div class="timeline-dates">
                                    <span>@stage.StartedAt.ToLocalTime().ToString("g")</span>
                                    @if (stage.CompletedAt.HasValue)
                                    {
                                        <span>· @Localizer["Shipments_Details_Stage_TimeRange", stage.CompletedAt.Value.ToLocalTime().ToString("g")]</span>
                                    }
                                </div>
                                @if (!string.IsNullOrWhiteSpace(stage.Notes))
                                {
                                    <p>@stage.Notes</p>
                                }
                            </div>
                        </li>
                    }
                </ul>
            }
        </article>

        <article class="details-card customs-card">
            <header>
                <h2>@Localizer["Shipments_Details_Customs_Title"]</h2>
            </header>
            @if (shipment.Customs is null)
            {
                <p class="empty">@Localizer["Shipments_Details_Customs_Empty"]</p>
            }
            else
            {
                <dl class="details-definition compact">
                    <div>
                        <dt>@Localizer["Shipments_Details_Customs_Status"]</dt>
                        <dd>@Localizer[$"Customs_Status_{shipment.Customs.Status}"]</dd>
                    </div>
                    <div>
                        <dt>@Localizer["Shipments_Details_Customs_Document"]</dt>
                        <dd>@(!string.IsNullOrWhiteSpace(shipment.Customs.DocumentNumber) ? shipment.Customs.DocumentNumber : "-")</dd>
                    </div>
                    <div>
                        <dt>@Localizer["Shipments_Details_Customs_Started"]</dt>
                        <dd>@shipment.Customs.StartedAt.ToLocalTime().ToString("g")</dd>
                    </div>
                    <div>
                        <dt>@Localizer["Shipments_Details_Customs_Completed"]</dt>
                        <dd>@(shipment.Customs.CompletedAt?.ToLocalTime().ToString("g") ?? "-")</dd>
                    </div>
                    <div class="full">
                        <dt>@Localizer["Shipments_Details_Customs_Notes"]</dt>
                        <dd>@(!string.IsNullOrWhiteSpace(shipment.Customs.Notes) ? shipment.Customs.Notes : "-")</dd>
                    </div>
                </dl>
            }
        </article>

        <article class="details-card list-card">
            <header>
                <h2>@Localizer["Shipments_Details_Items_Title"]</h2>
            </header>
            @if (shipment.Items.Count == 0)
            {
                <p class="empty">@Localizer["Shipments_Details_Items_Empty"]</p>
            }
            else
            {
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>@Localizer["Shipments_Details_Items_Variant"]</th>
                            <th>@Localizer["Shipments_Details_Items_Quantity"]</th>
                            <th>@Localizer["Shipments_Details_Items_Volume"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in shipment.Items)
                        {
                            <tr>
                                <td>
                                    <strong>@item.VariantName</strong>
                                    @if (!string.IsNullOrEmpty(item.VariantSpecies) || !string.IsNullOrEmpty(item.VariantGrade))
                                    {
                                        <div class="muted">
                                            @if (!string.IsNullOrEmpty(item.VariantSpecies))
                                            {
                                                <span>Tür: @item.VariantSpecies</span>
                                            }
                                            @if (!string.IsNullOrEmpty(item.VariantGrade))
                                            {
                                                <span>Kalite: @item.VariantGrade</span>
                                            }
                                        </div>
                                    }
                                    <div class="muted">Birim: @item.UnitOfMeasure</div>
                                </td>
                                <td>@item.Quantity @item.UnitOfMeasure</td>
                                <td>@item.Volume m³</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </article>

        <article class="details-card list-card">
            <header>
                <h2>@Localizer["Shipments_Details_TransportUnits_Title"]</h2>
            </header>
            @if (shipment.TransportUnits.Count == 0)
            {
                <p class="empty">@Localizer["Shipments_Details_TransportUnits_Empty"]</p>
            }
            else
            {
                <table class="details-table">
                    <thead>
                        <tr>
                            <th>@Localizer["Shipments_Details_TransportUnits_Mode"]</th>
                            <th>@Localizer["Shipments_Details_TransportUnits_Identifier"]</th>
                            <th>@Localizer["Shipments_Details_TransportUnits_Count"]</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var unit in shipment.TransportUnits)
                        {
                            <tr>
                                <td>@Localizer[$"Transport_Mode_{unit.Mode}"]</td>
                                <td>@(!string.IsNullOrWhiteSpace(unit.Identifier) ? unit.Identifier : "-")</td>
                                <td>@unit.Count</td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        </article>
    </section>
}

