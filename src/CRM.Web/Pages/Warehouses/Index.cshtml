@page
@model CRM.Web.Pages.Warehouses.IndexModel
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Warehouses_Page_Title"];

    string FormatLocation(string location) =>
        location == CRM.Web.Pages.Warehouses.IndexModel.UnspecifiedLocationLabel
            ? Localizer["Warehouses_Location_Unspecified"].Value
            : location;
}

@section Styles {
    <link rel="stylesheet" href="~/css/warehouses/list.css" asp-append-version="true" />
}

<section class="page-header warehouses-header">
    <div>
        <h1>@Localizer["Warehouses_Page_Title"]</h1>
        <p class="subtitle">@Localizer["Warehouses_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-primary" asp-page="Create">@Localizer["Warehouses_Action_Create"]</a>
    </div>
</section>

<section class="kpi-grid warehouses-kpis">
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Warehouses_Header_TotalWarehouses"]</span>
        <div class="kpi-value">@Model.TotalWarehouses</div>
        <span class="kpi-meta">@Localizer["Warehouses_Header_Active_Value", Model.ActiveWarehousesCount]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Warehouses_Header_Locations"]</span>
        <div class="kpi-value">@Model.DistinctLocationCount</div>
        <span class="kpi-meta">@Localizer["Warehouses_Header_Locations_Subtitle"]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Warehouses_Header_RecentUnloading"]</span>
        <div class="kpi-value">@Model.RecentUnloadingCount</div>
        <span class="kpi-meta">@Localizer["Warehouses_Header_RecentUnloading_Subtitle", Model.RecentUnloadingCount]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Warehouses_Header_TopLocation"]</span>
        <div class="kpi-value">@FormatLocation(Model.TopLocationName)</div>
        <span class="kpi-meta">@Localizer["Warehouses_Header_TopLocation_Value", Model.TopLocationWarehouseCount]</span>
    </article>
</section>

<section class="warehouses-insights">
    <article class="card analytics-card">
        <header class="card-header">
            <div>
                <h2>@Localizer["Warehouses_Chart_MonthlyVolume_Title"]</h2>
                <p>@Localizer["Warehouses_Chart_MonthlyVolume_Description"]</p>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="warehousesVolumeChart" data-warehouses-chart></canvas>
        </div>
    </article>
    <article class="card top-warehouses-card">
        <header class="card-header">
            <h2>@Localizer["Warehouses_TopWarehouses_Title"]</h2>
        </header>
        <ul class="top-warehouses-list">
            @if (Model.TopWarehouseStats.Any())
            {
                foreach (var stat in Model.TopWarehouseStats)
                {
                    <li>
                        <div class="warehouse-meta">
                            <span class="name">@stat.Name</span>
                            <span class="location">@FormatLocation(stat.Location)</span>
                        </div>
                        <div class="warehouse-stats">
                            <span>@Localizer["Warehouses_TopWarehouses_Volume", stat.TotalVolume]</span>
                            <span>
                                @Localizer["Warehouses_TopWarehouses_Trips", stat.TripCount]
                                Â·
                                @Localizer["Warehouses_TopWarehouses_LastUnloaded", stat.LastUnloadedAt.ToLocalTime().ToString("d", CultureInfo.CurrentUICulture)]
                            </span>
                        </div>
                    </li>
                }
            }
            else
            {
                <li class="empty">@Localizer["Warehouses_TopWarehouses_NoData"]</li>
            }
        </ul>
    </article>
</section>

<section class="warehouses-table-section">
    <article class="card table-card wide">
        <header class="card-header">
            <div>
                <h2>@Localizer["Warehouses_Table_Title"]</h2>
                <p>@Localizer["Warehouses_Table_Subtitle"]</p>
            </div>
            <div class="table-actions">
                <label class="search-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <circle cx="11" cy="11" r="7" />
                        <path d="m20 20-3.5-3.5" />
                    </svg>
                    <input type="search" data-warehouses-search placeholder="@Localizer["Warehouses_Search_Placeholder"].Value" />
                </label>
                <button type="button" class="btn btn-ghost" data-warehouses-search-clear>@Localizer["Customers_Clear_Button"]</button>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="warehousesTable" class="data-table" data-order-column="0">
                <thead>
                    <tr>
                        <th>@Localizer["Warehouses_Table_Name"]</th>
                        <th>@Localizer["Warehouses_Table_Location"]</th>
                        <th>@Localizer["Warehouses_Table_Contact"]</th>
                        <th class="text-end">@Localizer["Warehouses_Table_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var warehouse in Model.Warehouses)
                {
                    <tr>
                        <td>
                            <div class="cell-strong">@warehouse.Name</div>
                            @if (!string.IsNullOrWhiteSpace(warehouse.Notes))
                            {
                                <div class="cell-subtext">@warehouse.Notes</div>
                            }
                        </td>
                        <td>@FormatLocation(warehouse.Location ?? CRM.Web.Pages.Warehouses.IndexModel.UnspecifiedLocationLabel)</td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(warehouse.ContactPerson))
                            {
                                <div class="cell-strong">@warehouse.ContactPerson</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(warehouse.ContactPhone))
                            {
                                <div class="cell-subtext">@warehouse.ContactPhone</div>
                            }
                        </td>
                        <td class="text-end">
                            <a class="btn btn-icon" asp-page="Details" asp-route-id="@warehouse.Id" title="@Localizer["Warehouses_Action_Details"]">
                                <img src="~/images/detail.png" alt="@Localizer["Warehouses_Action_Details"]" width="18" height="18" loading="lazy" />
                            </a>
                            <a class="btn btn-icon" asp-page="Edit" asp-route-id="@warehouse.Id" title="@Localizer["Warehouses_Action_Edit"]">
                                <img src="~/images/edit.png" alt="@Localizer["Warehouses_Action_Edit"]" width="18" height="18" loading="lazy" />
                            </a>
                            <a class="btn btn-icon" asp-page="Delete" asp-route-id="@warehouse.Id" title="@Localizer["Warehouses_Action_Delete"]">
                                <img src="~/images/delete.png" alt="@Localizer["Warehouses_Action_Delete"]" width="18" height="18" loading="lazy" />
                            </a>
                        </td>
                    </tr>
                }
                @if (!Model.Warehouses.Any())
                {
                    <tr>
                        <td colspan="4" class="empty-state">@Localizer["Warehouses_Table_NoRecords"]</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </article>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        window.warehousesDashboard = {
            chart: {
                labels: @Html.Raw(Model.MonthlyVolumeLabelsJson ?? "[]"),
                data: @Html.Raw(Model.MonthlyVolumeDataJson ?? "[]"),
                noDataMessage: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Warehouses_Chart_NoData"].Value))
            }
        };
    </script>
    <script src="~/js/warehouses/list.js" asp-append-version="true"></script>
}
