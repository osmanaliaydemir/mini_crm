@page
@model CRM.Web.Pages.Customers.IndexModel
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Customers_Page_Title"];

    string FormatSegment(string? segment) =>
        segment == CRM.Web.Pages.Customers.IndexModel.UnspecifiedSegmentLabel || string.IsNullOrWhiteSpace(segment)
            ? Localizer["Customers_Segment_Unspecified"].Value
            : segment;
}

@section Styles {
    <link rel="stylesheet" href="~/css/common/datatable.css" asp-append-version="true" />
    <link rel="stylesheet" href="~/css/customers/list.css" asp-append-version="true" />
}

<section class="page-header customers-header">
    <div>
        <h1>@Localizer["Customers_Page_Title"]</h1>
        <p class="subtitle">@Localizer["Customers_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <div class="btn-group">
            <a class="btn btn-ghost" asp-page-handler="Export" asp-route-format="excel" asp-route-search="@Model.Search">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                @Localizer["Common_Export_Excel"]
            </a>
            <a class="btn btn-ghost" asp-page-handler="Export" asp-route-format="csv" asp-route-search="@Model.Search">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="16" height="16" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5M16.5 12L12 16.5m0 0L7.5 12m4.5 4.5V3" />
                </svg>
                @Localizer["Common_Export_CSV"]
            </a>
        </div>
        <a class="btn btn-primary" asp-page="Create">@Localizer["Customers_Action_Create"]</a>
    </div>
</section>

<section class="kpi-grid customers-kpis">
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Customers_Header_TotalCustomers"].Value, 
        value = Model.TotalCustomers, 
        meta = Localizer["Customers_Header_New_Value", Model.NewCustomersCount].Value 
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Customers_Header_Segments"].Value, 
        value = Model.DistinctSegmentCount, 
        meta = Localizer["Customers_Header_Segments_Subtitle"].Value 
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Customers_Header_Interactions"].Value, 
        value = Model.RecentInteractionsCount, 
        meta = Localizer["Customers_Header_Interactions_Subtitle"].Value 
    })
    @await Component.InvokeAsync("KpiCard", new { 
        label = Localizer["Customers_Header_TopSegment"].Value, 
        value = FormatSegment(Model.TopSegmentName), 
        meta = Localizer["Customers_Header_TopSegment_Value", Model.TopSegmentCustomerCount].Value 
    })
</section>

<section class="customers-insights">
    <article class="card analytics-card">
        <header class="card-header">
            <div>
                <h2>@Localizer["Customers_Chart_MonthlyInteractions_Title"]</h2>
                <p>@Localizer["Customers_Chart_MonthlyInteractions_Description"]</p>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="customersInteractionsChart" data-customers-chart></canvas>
        </div>
    </article>

    <article class="card top-customers-card">
        <header class="card-header">
            <h2>@Localizer["Customers_TopCustomers_Title"]</h2>
        </header>
        <ul class="top-customers-list">
            @if (Model.TopCustomerStats.Any())
            {
                foreach (var stat in Model.TopCustomerStats)
                {
                    <li>
                        <div class="customer-meta">
                            <span class="name">@stat.Name</span>
                            <span class="segment">@FormatSegment(stat.Segment)</span>
                        </div>
                        <div class="customer-stats">
                            <span class="interactions">@Localizer["Customers_TopCustomers_Interactions", stat.InteractionCount]</span>
                            <span>@Localizer["Customers_TopCustomers_LastInteraction", stat.LastInteractionAt.ToLocalTime().ToString("d", CultureInfo.CurrentUICulture)]</span>
                        </div>
                    </li>
                }
            }
            else
            {
                <li class="empty">@Localizer["Customers_TopCustomers_NoData"]</li>
            }
        </ul>
    </article>
</section>

<section class="customers-table-section">
    <article class="card table-card wide">
        <header class="card-header">
            <div>
                <h2>@Localizer["Customers_Table_Title"]</h2>
                <p>@Localizer["Customers_Table_Subtitle"]</p>
            </div>
            <div class="table-actions">
                <label class="search-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <circle cx="11" cy="11" r="7" />
                        <path d="m20 20-3.5-3.5" />
                    </svg>
                    <input type="search" name="search" value="@Model.Search" data-customers-search placeholder="@Localizer["Customers_Search_Placeholder"].Value" />
                </label>
                <button type="button" class="btn btn-ghost" data-customers-search-clear>@Localizer["Customers_Clear_Button"]</button>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="customersTable" class="data-table" data-order-column="0">
                <thead>
                    <tr>
                        <th>@Localizer["Customers_Table_Name"]</th>
                        <th>@Localizer["Customers_Table_Segment"]</th>
                        <th>@Localizer["Customers_Table_Contact"]</th>
                        <th>@Localizer["Customers_Table_Notes"]</th>
                        <th class="text-end">@Localizer["Customers_Table_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                @if (Model.Customers.Any())
                {
                    @foreach (var customer in Model.Customers)
                    {
                        <tr>
                            <td>
                                <div class="cell-strong">@customer.Name</div>
                                @if (!string.IsNullOrWhiteSpace(customer.LegalName))
                                {
                                    <div class="cell-subtext">@customer.LegalName</div>
                                }
                            </td>
                            <td>@FormatSegment(customer.Segment)</td>
                            <td>
                                @if (!string.IsNullOrWhiteSpace(customer.Email) || !string.IsNullOrWhiteSpace(customer.Phone))
                                {
                                    @if (!string.IsNullOrWhiteSpace(customer.Email))
                                    {
                                        <div class="cell-strong">@customer.Email</div>
                                    }
                                    @if (!string.IsNullOrWhiteSpace(customer.Phone))
                                    {
                                        <div class="cell-subtext">@customer.Phone</div>
                                    }
                                }
                                else
                                {
                                    <span>-</span>
                                }
                            </td>
                            <td class="cell-subtext">@(!string.IsNullOrWhiteSpace(customer.Notes) ? customer.Notes : Localizer["Customers_Details_Notes_Empty"].Value)</td>
                            <td class="text-end">
                                @await Component.InvokeAsync("ActionButtons", new { 
                                    detailsPage = "Details", 
                                    editPage = "Edit", 
                                    deletePage = "Delete", 
                                    detailsId = customer.Id, 
                                    editId = customer.Id, 
                                    deleteId = customer.Id,
                                    detailsTitle = Localizer["Customers_Action_Details"].Value,
                                    editTitle = Localizer["Customers_Action_Edit"].Value,
                                    deleteTitle = Localizer["Customers_Action_Delete"].Value
                                })
                            </td>
                        </tr>
                    }
                }
                </tbody>
            </table>
            @if (!Model.Customers.Any())
            {
                <div class="table-empty-message" style="display: none; padding: 2rem; text-align: center; color: #64748b;">
                    @Localizer["Customers_Table_NoRecords"]
                </div>
            }
        </div>
    </article>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        window.customersDashboard = {
            chart: {
                labels: @Html.Raw(Model.MonthlyInteractionLabelsJson ?? "[]"),
                data: @Html.Raw(Model.MonthlyInteractionDataJson ?? "[]"),
                noDataMessage: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Customers_Chart_NoData"].Value)),
                pointLabel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Customers_Chart_Point_Label"].Value))
            }
        };
    </script>
    <script src="~/js/customers/list.js" asp-append-version="true"></script>
}

