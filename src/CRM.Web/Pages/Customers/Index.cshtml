@page
@model CRM.Web.Pages.Customers.IndexModel
@using System.Globalization
@using Microsoft.Extensions.Localization
@inject IStringLocalizer<SharedResource> Localizer

@{
    Layout = "_DashboardLayout";
    ViewData["Title"] = Localizer["Customers_Page_Title"];

    string FormatSegment(string? segment) =>
        segment == CRM.Web.Pages.Customers.IndexModel.UnspecifiedSegmentLabel || string.IsNullOrWhiteSpace(segment)
            ? Localizer["Customers_Segment_Unspecified"].Value
            : segment;
}

@section Styles {
    <link rel="stylesheet" href="~/css/customers/list.css" asp-append-version="true" />
}

<section class="page-header customers-header">
    <div>
        <h1>@Localizer["Customers_Page_Title"]</h1>
        <p class="subtitle">@Localizer["Customers_Page_Subtitle"]</p>
    </div>
    <div class="header-actions">
        <a class="btn btn-primary" asp-page="Create">@Localizer["Customers_Action_Create"]</a>
    </div>
</section>

<section class="kpi-grid customers-kpis">
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Customers_Header_TotalCustomers"]</span>
        <div class="kpi-value">@Model.TotalCustomers</div>
        <span class="kpi-meta">@Localizer["Customers_Header_New_Value", Model.NewCustomersCount]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Customers_Header_Segments"]</span>
        <div class="kpi-value">@Model.DistinctSegmentCount</div>
        <span class="kpi-meta">@Localizer["Customers_Header_Segments_Subtitle"]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Customers_Header_Interactions"]</span>
        <div class="kpi-value">@Model.RecentInteractionsCount</div>
        <span class="kpi-meta">@Localizer["Customers_Header_Interactions_Subtitle"]</span>
    </article>
    <article class="kpi-card">
        <span class="kpi-label">@Localizer["Customers_Header_TopSegment"]</span>
        <div class="kpi-value">@FormatSegment(Model.TopSegmentName)</div>
        <span class="kpi-meta">@Localizer["Customers_Header_TopSegment_Value", Model.TopSegmentCustomerCount]</span>
    </article>
</section>

<section class="customers-insights">
    <article class="card analytics-card">
        <header class="card-header">
            <div>
                <h2>@Localizer["Customers_Chart_MonthlyInteractions_Title"]</h2>
                <p>@Localizer["Customers_Chart_MonthlyInteractions_Description"]</p>
            </div>
        </header>
        <div class="chart-wrapper">
            <canvas id="customersInteractionsChart" data-customers-chart></canvas>
        </div>
    </article>

    <article class="card top-customers-card">
        <header class="card-header">
            <h2>@Localizer["Customers_TopCustomers_Title"]</h2>
        </header>
        <ul class="top-customers-list">
            @if (Model.TopCustomerStats.Any())
            {
                foreach (var stat in Model.TopCustomerStats)
                {
                    <li>
                        <div class="customer-meta">
                            <span class="name">@stat.Name</span>
                            <span class="segment">@FormatSegment(stat.Segment)</span>
                        </div>
                        <div class="customer-stats">
                            <span class="interactions">@Localizer["Customers_TopCustomers_Interactions", stat.InteractionCount]</span>
                            <span>@Localizer["Customers_TopCustomers_LastInteraction", stat.LastInteractionAt.ToLocalTime().ToString("d", CultureInfo.CurrentUICulture)]</span>
                        </div>
                    </li>
                }
            }
            else
            {
                <li class="empty">@Localizer["Customers_TopCustomers_NoData"]</li>
            }
        </ul>
    </article>

    <article class="card top-segments-card">
        <header class="card-header">
            <h2>@Localizer["Customers_TopSegments_Title"]</h2>
        </header>
        <ul class="top-segments-list">
            @if (Model.CustomerSegmentStats.Any())
            {
                var rank = 1;
                foreach (var segment in Model.CustomerSegmentStats.Take(5))
                {
                    <li>
                        <span class="rank">@rank</span>
                        <span class="segment">@FormatSegment(segment.Segment)</span>
                        <span class="count">@Localizer["Customers_TopSegments_Count", segment.CustomerCount]</span>
                    </li>
                    rank++;
                }
            }
            else
            {
                <li class="empty">@Localizer["Customers_TopSegments_NoData"]</li>
            }
        </ul>
    </article>
</section>

<section class="customers-table-section">
    <article class="card table-card wide">
        <header class="card-header">
            <div>
                <h2>@Localizer["Customers_Table_Title"]</h2>
                <p>@Localizer["Customers_Table_Subtitle"]</p>
            </div>
            <div class="table-actions">
                <label class="search-control">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" width="18" height="18">
                        <circle cx="11" cy="11" r="7" />
                        <path d="m20 20-3.5-3.5" />
                    </svg>
                    <input type="search" name="search" value="@Model.Search" data-customers-search placeholder="@Localizer["Customers_Search_Placeholder"].Value" />
                </label>
                <button type="button" class="btn btn-ghost" data-customers-search-clear>@Localizer["Customers_Clear_Button"]</button>
            </div>
        </header>
        <div class="table-wrapper">
            <table id="customersTable" class="data-table" data-order-column="0">
                <thead>
                    <tr>
                        <th>@Localizer["Customers_Table_Name"]</th>
                        <th>@Localizer["Customers_Table_Segment"]</th>
                        <th>@Localizer["Customers_Table_Contact"]</th>
                        <th>@Localizer["Customers_Table_Notes"]</th>
                        <th class="text-end">@Localizer["Customers_Table_Actions"]</th>
                    </tr>
                </thead>
                <tbody>
                @foreach (var customer in Model.Customers)
                {
                    <tr>
                        <td>
                            <div class="cell-strong">@customer.Name</div>
                            @if (!string.IsNullOrWhiteSpace(customer.LegalName))
                            {
                                <div class="cell-subtext">@customer.LegalName</div>
                            }
                        </td>
                        <td>@FormatSegment(customer.Segment)</td>
                        <td>
                            @if (!string.IsNullOrWhiteSpace(customer.Email))
                            {
                                <div class="cell-strong">@customer.Email</div>
                            }
                            @if (!string.IsNullOrWhiteSpace(customer.Phone))
                            {
                                <div class="cell-subtext">@customer.Phone</div>
                            }
                        </td>
                        <td class="cell-subtext">@(!string.IsNullOrWhiteSpace(customer.Notes) ? customer.Notes : Localizer["Customers_Details_Notes_Empty"].Value)</td>
                        <td class="text-end">
                            <a class="btn btn-icon" asp-page="Details" asp-route-id="@customer.Id" title="@Localizer["Customers_Action_Details"]">
                                <img src="~/images/detail.png" alt="@Localizer["Customers_Action_Details"]" width="18" height="18" loading="lazy" />
                            </a>
                            <a class="btn btn-icon" asp-page="Edit" asp-route-id="@customer.Id" title="@Localizer["Customers_Action_Edit"]">
                                <img src="~/images/edit.png" alt="@Localizer["Customers_Action_Edit"]" width="18" height="18" loading="lazy" />
                            </a>
                            <a class="btn btn-icon" asp-page="Delete" asp-route-id="@customer.Id" title="@Localizer["Customers_Action_Delete"]">
                                <img src="~/images/delete.png" alt="@Localizer["Customers_Action_Delete"]" width="18" height="18" loading="lazy" />
                            </a>
                        </td>
                    </tr>
                }
                @if (!Model.Customers.Any())
                {
                    <tr>
                        <td colspan="5" class="empty-state">@Localizer["Customers_Table_NoRecords"]</td>
                    </tr>
                }
                </tbody>
            </table>
        </div>
    </article>
</section>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.6/dist/chart.umd.min.js"></script>
    <script>
        window.customersDashboard = {
            chart: {
                labels: @Html.Raw(Model.MonthlyInteractionLabelsJson ?? "[]"),
                data: @Html.Raw(Model.MonthlyInteractionDataJson ?? "[]"),
                noDataMessage: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Customers_Chart_NoData"].Value)),
                pointLabel: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Localizer["Customers_Chart_Point_Label"].Value))
            }
        };
    </script>
    <script src="~/js/customers/list.js" asp-append-version="true"></script>
}

